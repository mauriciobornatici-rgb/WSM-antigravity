# Execution State Snapshot

Last updated: 2026-02-19
Status: IN_PROGRESS
Current block: P2
Current task: P2.8 - Integracion de paginacion UI en modulos de alto volumen

## Resume From Here
1. Validar en staging UX de paginacion en `Orders`, `Inventory` y `Settings` (Audit) con datos reales y navegacion entre paginas.
2. Completar ultimo barrido de idioma/terminologia en modulos secundarios aun no tocados por esta pasada.
3. Cerrar plan de rotacion de secretos (JWT/DB) fuera de codigo y validar post-rotacion en staging.
4. Definir si se migra `Settings` a React Query completo (hoy solo auditoria tiene paginacion activa con carga dedicada).
5. Mantener validacion incremental completa (`server test + smokes`, `client lint/test/build`) en cada lote.

## Completed
- Consolidated gap list and priority order.
- Created persistent execution docs:
  - `docs/execution/MASTER_PLAN.md`
  - `docs/execution/STATE.md`
  - `docs/execution/CHANGELOG_EXECUTION.md`
- P0.1 completed:
  - Removed vulnerable `window.open + document.write` print flow in:
    - `packages/client/src/pages/ReturnsAndWarranties.tsx`
  - Replaced with safe JSX-rendered printable area + `window.print`.
  - Verified no `document.write`/`window.open` usage remains in frontend.
- P0.2 completed:
  - Implemented atomic stock check and deduction during order creation in:
    - `packages/server/services/sales.service.js`
  - Added row-level lock (`FOR UPDATE`) and transactional inventory decrement.
  - Added inventory movement logging for sales deductions.
  - Aligned frontend messages with backend stock behavior in:
    - `packages/client/src/pages/Orders.tsx`
- P0.3 partial progress:
  - `GET /api/products` now returns `stock_current` derived from `inventory` (canonical read path):
    - `packages/server/services/inventory.service.js`
    - `packages/server/controllers/inventoryController.js`
- P0.3 completed:
  - Frontend stock reads aligned with canonical `stock_current` from `/api/products`:
    - `packages/client/src/pages/POS.tsx`
    - `packages/client/src/pages/Inventory.tsx`
  - Product type updated to reflect backend contract:
    - `packages/client/src/types/index.ts`
  - Inventory service response normalized to avoid leaking helper fields:
    - `packages/server/services/inventory.service.js`
- P0.5 completed:
  - Server startup now waits for DB initialization before listening:
    - `packages/server/index.js`
- P0.7 completed:
  - MySQL TLS toggle added (`DB_SSL`, `DB_SSL_REJECT_UNAUTHORIZED`):
    - `packages/server/config/db.js`
    - `.env.example`
- P0.4 completed:
  - Added deterministic base migration covering runtime-required tables:
    - `packages/server/migrations/000_create_core_schema.sql`
  - Refactored DB init to migration-first bootstrap + deterministic seeding only:
    - `packages/server/config/initDb.js`
  - Converted schema reference to migrations-first policy:
    - `packages/server/db/schema/schema.sql`
  - Staging runtime validation:
    - backend startup completed with migration `000_create_core_schema.sql` applied successfully.
- P0.6 completed:
  - Added centralized environment policy + validation:
    - `packages/server/config/env.js`
  - Enforced startup config in runtime:
    - `packages/server/index.js`
    - `packages/server/config/db.js`
  - Hardened production/staging error responses:
    - `packages/server/middleware/errorMiddleware.js`
  - Documented explicit non-dev override and env profiles:
    - `.env.example`
- P0.8 completed:
  - Enforced invoice payment invariants in sales service:
    - `payment_status` now derived from effective payments (`pending|partial|paid`).
    - rejects overpayment (`PAYMENTS_EXCEED_TOTAL`).
    - prevents invalid payment lines.
  - Added accounting trace for invoice collections:
    - each payment line writes to `transactions` (`type='sale'`).
  - Synced order payment state with invoice state:
    - `orders.payment_status` no longer hardcoded to `paid`.
    - `orders.status` only escalates to `completed` when payment is fully paid.
  - Files:
    - `packages/server/services/sales.service.js`
- P1.1 completed:
  - `approveClientReturn` moved from placeholder to transactional, idempotent flow.
  - Approval now performs:
    - stock impact (`inventory` + `inventory_movements`) according to item condition.
    - automatic credit note issuance linked to return.
    - accounting trace in `transactions`.
    - client balance update for issued credit.
  - Added domain error mapping + audit logging for approval action.
  - Files:
    - `packages/server/services/warranties.service.js`
    - `packages/server/controllers/warrantiesController.js`
- P1.2 completed:
  - Added backend order state machine and invalid transition blocking.
  - `updateOrderStatus` now uses transition validation instead of blind updates.
  - `dispatchOrder` and `deliverOrder` now validate allowed transition path.
  - Compatibility aliases preserved for legacy statuses (`confirmed` -> `picking`, `paid` -> `packed`).
  - Files:
    - `packages/server/services/sales.service.js`
    - `packages/server/controllers/salesController.js`
- P1.3 completed:
  - Added transactional sequence allocator:
    - `packages/server/utils/documentSequence.js`
  - Added migration:
    - `packages/server/migrations/002_create_document_sequences.sql`
  - Migrated numbering to concurrency-safe sequences:
    - invoices (`sales.service`)
    - purchase orders, receptions, supplier returns (`procurementController`)
    - credit notes (`warranties.service` and manual credit note controller flow)
  - Manual credit note creation now runs in explicit transaction with audit trace.
  - Staging validation:
    - migration `002_create_document_sequences.sql` executed successfully at boot.
- P1.4 completed:
  - Removed remaining dynamic `ORDER BY` surface in sales listing.
  - Added strict allowlist sanitization for `getOrders(..., options.orderBy)` in backend service.
  - File:
    - `packages/server/services/sales.service.js`
- P1.5 completed:
  - Fiscal/company config now centralized and consumable for all authenticated roles.
  - Backend:
    - Added authenticated public profile endpoint for company settings:
      - `GET /api/settings/company/public`
    - Extended `company_settings` payload/updates with operational fields:
      - `operation.tax_rate`
      - `operation.default_currency`
    - Preserved existing values when `operation` is omitted in updates.
    - Files:
      - `packages/server/controllers/settingsController.js`
      - `packages/server/routes/settingsRoutes.js`
      - `packages/server/middleware/validationMiddleware.js`
  - Frontend:
    - Added centralized settings helper with defaults/fallback/formatters:
      - `packages/client/src/lib/companySettings.ts`
    - Replaced hardcoded legal/fiscal constants in print flows:
      - `packages/client/src/pages/Invoices.tsx`
      - `packages/client/src/pages/POS.tsx`
      - `packages/client/src/pages/Orders.tsx`
    - Added API method for public company profile:
      - `packages/client/src/services/api.ts`
    - Extended company settings type with operation fields:
      - `packages/client/src/types/index.ts`
    - Settings page now syncs tax/currency with backend company settings:
      - `packages/client/src/pages/Settings.tsx`
  - Validation:
    - Backend syntax checks passed (`node --check`).
    - Frontend lint passed on touched files.
    - Frontend typecheck passed (`tsc --noEmit`).
- P2.1 partial progress:
  - Improved contrast and interaction accessibility in receptions tables/tabs:
    - stronger table header/body contrast classes
    - higher-contrast status badges with ring outlines
    - focus-visible rings on action and filter controls
  - File:
    - `packages/client/src/pages/Receptions.tsx`
  - Validation:
    - Frontend lint/typecheck passed for touched files (one non-blocking hooks warning in `Receptions.tsx`).
- P2.1 partial progress (continued):
  - Reinforced POS checkout flow and operator UX:
    - quick client creation in-place
    - expanded payment/invoice variants (`credit_card`, `transfer`, invoice type selector)
    - success confirmation dialog with order/invoice trace
    - category filter in products grid
  - File:
    - `packages/client/src/pages/POS.tsx`
  - Validation:
    - Frontend typecheck and build passed.
- P2.1 partial progress (continued):
  - Improved contrast/accessibility in purchase orders table and controls:
    - stronger status badge contrast with ring outlines
    - unified table typography classes for dense data
    - focus-visible rings and aria-label on row actions
    - fixed hooks warning by stabilizing `loadOrders` with `useCallback`
  - File:
    - `packages/client/src/pages/PurchaseOrders.tsx`
  - Validation:
    - Frontend lint/typecheck/build passed.
- P2.2 partial progress:
  - Dashboard switched from static demo values to real operational data.
  - Metrics now computed from API data with role-aware fallback:
    - sales totals (transactions when available, orders fallback)
    - pending warehouse orders
    - low stock alerts
    - completion rate
  - Replaced placeholder sections with:
    - 7-day sales panel
    - recent activity feed from live data
  - File:
    - `packages/client/src/pages/Dashboard.tsx`
  - Validation:
    - Frontend lint/typecheck/build passed.
- P2.2 partial progress (continued):
  - Invoices email action no longer reports false "success" as if it were real.
  - Added explicit simulation messaging and feature flag gate:
    - `VITE_ENABLE_INVOICE_EMAIL` controls behavior
    - without integration, UI now informs user that email is simulated/pending
  - Normalized remaining English label in manual invoice item adder (`Agregar`).
  - File:
    - `packages/client/src/pages/Invoices.tsx`
  - Validation:
    - Frontend lint/typecheck/build passed.
- P2.3 partial progress:
  - Accounting page now uses robust async handling:
    - replaced promise chain without catch by `try/catch/finally`
    - standardized user-facing error feedback via `showErrorToast`
    - added explicit fallback UI state when accounting data cannot be loaded
  - Locale consistency:
    - day labels switched to `es-AR`
  - File:
    - `packages/client/src/pages/Accounting.tsx`
  - Validation:
    - Frontend lint/typecheck/build passed.
- P2.3 partial progress (continued):
  - Picking page:
    - stabilized async loading with `useCallback` + safe `useEffect` dependency
    - added visible error state with retry action for initial load failures
  - Suppliers page:
    - added explicit loading state for provider catalog
    - added visible error state + retry action
    - added filtered empty-state message
    - stabilized supplier detail loading effect with awaited async call
    - normalized key labels to AR terminology (`CUIT/DNI`)
  - Clients page:
    - stabilized async loading with `useCallback` + safe `useEffect` dependency
    - added visible error banner + retry action
    - normalized fiscal labels to AR terminology (`CUIT/DNI`)
    - normalized monetary formatting to `es-AR` / `ARS`
  - Files:
    - `packages/client/src/pages/Picking.tsx`
    - `packages/client/src/pages/Suppliers.tsx`
    - `packages/client/src/pages/Clients.tsx`
  - Validation:
    - Frontend lint/typecheck/build passed.
- P2.3 partial progress (inventory reliability):
  - Inventory page hardened against duplicate load bursts (notably in dev StrictMode):
    - request deduplication via shared in-flight promise
    - short-lived cache to prevent immediate duplicated fetches on remount
    - inline load error + retry action instead of repeated toast spam
    - cache invalidation on create/update/delete to keep data fresh
  - File:
    - `packages/client/src/pages/Inventory.tsx`
  - Validation:
    - Frontend lint/typecheck/build passed.
- P2.3 partial progress (terminology consistency):
  - Settings page fiscal label normalized to AR wording (`CUIT / DNI`).
  - File:
    - `packages/client/src/pages/Settings.tsx`
  - Validation:
    - Frontend lint/typecheck/build passed.
- P2.4 partial progress:
  - Orders page migrated from manual fetch lifecycle to React Query:
    - data queries for `orders`, `products`, and `clients`
    - mutations for create/status/dispatch/deliver/invoice actions
    - cache invalidation strategy after successful mutations
  - Added explicit visible error banner with retry action for initial data load failures.
  - Removed manual `loadData()` refresh cycle and local submit/loading flags now derived from query/mutation state.
  - File:
    - `packages/client/src/pages/Orders.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/Orders.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.4 partial progress (continued):
  - Purchase Orders page migrated to React Query with filter-aware query key:
    - query by `status` filter (`all|draft|sent|partial|received`)
    - mutations for create and approve with cache invalidation
  - Added explicit load-error banner with retry action.
  - Removed manual `useEffect/useCallback` reload cycle.
  - File:
    - `packages/client/src/pages/PurchaseOrders.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/Orders.tsx src/pages/PurchaseOrders.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.4 partial progress (continued):
  - Receptions page migrated to React Query with tab-aware conditional queries (`enabled`):
    - pending purchase orders for reception
    - receptions history with status filter
    - supplier returns list
  - Mutations migrated with cache invalidation:
    - create reception, approve reception
    - create return, approve return
  - Added visible error state with retry bound to the active tab/query.
  - File:
    - `packages/client/src/pages/Receptions.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/Receptions.tsx src/pages/Orders.tsx src/pages/PurchaseOrders.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.4 partial progress (shared infrastructure):
  - Added centralized client query-key registry:
    - `packages/client/src/lib/queryKeys.ts`
  - Refactored migrated pages to consume shared keys:
    - `packages/client/src/pages/Orders.tsx`
    - `packages/client/src/pages/PurchaseOrders.tsx`
    - `packages/client/src/pages/Receptions.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/lib/queryKeys.ts src/pages/Orders.tsx src/pages/PurchaseOrders.tsx src/pages/Receptions.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.5 partial progress:
  - Inventory page decomposed into dedicated data/helper and table rendering modules:
    - extracted inventory snapshot/cache logic to:
      - `packages/client/src/lib/inventorySnapshot.ts`
    - extracted table rendering/actions to:
      - `packages/client/src/components/products/InventoryTable.tsx`
    - simplified page orchestration to state + dialogs + search:
      - `packages/client/src/pages/Inventory.tsx`
  - Behavior preserved (same CRUD, same retry, same stock derivation and cache invalidation flow).
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/Inventory.tsx src/components/products/InventoryTable.tsx src/lib/inventorySnapshot.ts`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.5 partial progress (continued):
  - Receptions page decomposed into modular sections while preserving existing behavior and React Query integration:
    - shared types:
      - `packages/client/src/components/receptions/types.ts`
    - shared status helpers:
      - `packages/client/src/components/receptions/receptionStatus.ts`
    - tab sections:
      - `packages/client/src/components/receptions/PendingOrdersSection.tsx`
      - `packages/client/src/components/receptions/SupplierReturnsSection.tsx`
      - `packages/client/src/components/receptions/ReceptionsHistorySection.tsx`
    - page orchestration simplified:
      - `packages/client/src/pages/Receptions.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/Receptions.tsx src/components/receptions/PendingOrdersSection.tsx src/components/receptions/SupplierReturnsSection.tsx src/components/receptions/ReceptionsHistorySection.tsx src/components/receptions/receptionStatus.ts src/components/receptions/types.ts`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.6 partial progress:
  - Wording/locale normalization pass (Spanish AR) in operational modules:
    - `packages/client/src/pages/Inventory.tsx`
    - `packages/client/src/pages/Orders.tsx`
    - `packages/client/src/pages/Receptions.tsx`
    - `packages/client/src/components/products/InventoryTable.tsx`
    - `packages/client/src/components/receptions/PendingOrdersSection.tsx`
    - `packages/client/src/components/receptions/ReceptionForm.tsx`
    - `packages/client/src/components/receptions/ReturnForm.tsx`
  - Normalized accents and terminology in user-visible labels/messages (e.g. `Gestión`, `Recepción`, `Devolución`, `Método`, `Dirección`, `Categoría`).
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/Inventory.tsx src/pages/Orders.tsx src/pages/Receptions.tsx src/components/products/InventoryTable.tsx src/components/receptions/PendingOrdersSection.tsx src/components/receptions/ReceptionForm.tsx src/components/receptions/ReturnForm.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.5 partial progress (continued):
  - POS page decomposed into focused operational modules while preserving behavior and API contracts.
  - New modular components/types:
    - `packages/client/src/components/pos/types.ts`
    - `packages/client/src/components/pos/ProductCatalogCard.tsx`
    - `packages/client/src/components/pos/CartPanelCard.tsx`
    - `packages/client/src/components/pos/PaymentDialog.tsx`
    - `packages/client/src/components/pos/QuickClientDialog.tsx`
    - `packages/client/src/components/pos/CheckoutSuccessDialog.tsx`
  - Page orchestration simplified:
    - `packages/client/src/pages/POS.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/POS.tsx src/components/pos/types.ts src/components/pos/ProductCatalogCard.tsx src/components/pos/CartPanelCard.tsx src/components/pos/PaymentDialog.tsx src/components/pos/QuickClientDialog.tsx src/components/pos/CheckoutSuccessDialog.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.5 partial progress (continued):
  - Invoices page decomposed into focused modules preserving behavior and current API contracts.
  - New modules:
    - `packages/client/src/components/invoices/types.ts`
    - `packages/client/src/components/invoices/invoiceUtils.tsx`
    - `packages/client/src/components/invoices/InvoiceCreateDialog.tsx`
    - `packages/client/src/components/invoices/InvoicesTable.tsx`
    - `packages/client/src/components/invoices/InvoiceDocument.tsx`
    - `packages/client/src/components/invoices/InvoicePreviewDialog.tsx`
    - `packages/client/src/components/invoices/PrintableInvoiceArea.tsx`
  - Orchestration page simplified:
    - `packages/client/src/pages/Invoices.tsx`
  - Locale pass included in touched module (`ítems`, `envío`, `integración`, `previsualización`, etc.).
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/Invoices.tsx src/components/invoices/types.ts src/components/invoices/invoiceUtils.tsx src/components/invoices/InvoiceCreateDialog.tsx src/components/invoices/InvoicesTable.tsx src/components/invoices/InvoiceDocument.tsx src/components/invoices/InvoicePreviewDialog.tsx src/components/invoices/PrintableInvoiceArea.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.6 partial progress:
  - Added centralized toast deduplication strategy for async errors (global React Query + local handlers):
    - avoids duplicate notifications for the same error object
    - adds short signature window guard to reduce repeated bursts
  - App now routes React Query global errors through shared `showErrorToast`.
  - Files:
    - `packages/client/src/lib/errorHandling.ts`
    - `packages/client/src/App.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/App.tsx src/lib/errorHandling.ts`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.6 partial progress (continued):
  - UI language normalization pass (Spanish AR) in navigation/auth/core labels:
    - sidebar labels (`Órdenes`, `Facturación`, `Configuración`, `Depósito`, etc.)
    - auth/session user messages
    - operational headings/messages (`garantías`, `crédito`, `recepción`, `descripción`, etc.)
  - Files:
    - `packages/client/src/layout/AppLayout.tsx`
    - `packages/client/src/context/AuthContext.tsx`
    - `packages/client/src/pages/Dashboard.tsx`
    - `packages/client/src/pages/Login.tsx`
    - `packages/client/src/pages/Picking.tsx`
    - `packages/client/src/pages/ReturnsAndWarranties.tsx`
    - `packages/client/src/pages/PurchaseOrders.tsx`
    - `packages/client/src/pages/Settings.tsx`
    - `packages/client/src/pages/ClientDetail.tsx`
    - `packages/client/src/components/users/UserForm.tsx`
    - `packages/client/src/components/pos/QuickClientDialog.tsx`
  - Validation:
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
  - Lint note:
    - targeted lint run reveals pre-existing errors unrelated to this pass in:
      - `packages/client/src/context/AuthContext.tsx`
      - `packages/client/src/components/users/UserForm.tsx`
      - `packages/client/src/pages/ReturnsAndWarranties.tsx`
- P2.6 partial progress (lint stabilization):
  - Cleared remaining blocking lint findings in active modules:
    - `Login`: removed unused `catch` variable
    - `ClientDetail`: stabilized `loadClientData` with `useCallback` + safe effect dependency
    - `AuthContext`: explicit Fast Refresh lint bypass for mixed provider/hook exports
    - `UserForm`: switched local form state to reducer-based replacement flow
    - `ReturnsAndWarranties`: removed hook ordering warnings and documented temporary `set-state-in-effect` lint bypass pending React Query migration
  - Files:
    - `packages/client/src/pages/Login.tsx`
    - `packages/client/src/pages/ClientDetail.tsx`
    - `packages/client/src/context/AuthContext.tsx`
    - `packages/client/src/components/users/UserForm.tsx`
    - `packages/client/src/pages/ReturnsAndWarranties.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/context/AuthContext.tsx src/components/users/UserForm.tsx src/pages/Login.tsx src/pages/ReturnsAndWarranties.tsx src/pages/ClientDetail.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.6 partial progress (continued):
  - Migrated `ReturnsAndWarranties` from manual `useEffect + loadData` flow to React Query:
    - query-driven data loading per tab
    - mutation-driven writes with cache invalidation
    - explicit loading and retry states per section
    - removed temporary lint bypass from the module
  - Added shared query keys for this domain:
    - `warranties`
    - `client-returns`
    - `credit-notes`
  - Files:
    - `packages/client/src/pages/ReturnsAndWarranties.tsx`
    - `packages/client/src/lib/queryKeys.ts`
  - Validation:
    - `npm -w @wsm/client exec eslint src/pages/ReturnsAndWarranties.tsx src/lib/queryKeys.ts`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.6 partial progress (backend hardening):
  - Enforced strong password policy for user create/update in backend (min length + complexity).
  - Centralized JWT runtime settings usage in auth/controller layer:
    - use validated env config (`jwtSecret`, `jwtExpiresIn`) instead of direct `process.env` checks.
  - Added explicit env setting for token expiration:
    - `JWT_EXPIRES_IN` in `.env.example`.
  - Files:
    - `packages/server/utils/passwordPolicy.js`
    - `packages/server/middleware/validationMiddleware.js`
    - `packages/server/controllers/userController.js`
    - `packages/server/middleware/authMiddleware.js`
    - `packages/server/config/env.js`
    - `.env.example`
  - Validation:
    - `node --check packages/server/controllers/userController.js`
    - `node --check packages/server/middleware/authMiddleware.js`
    - `node --check packages/server/middleware/validationMiddleware.js`
    - `node --check packages/server/config/env.js`
    - `node --check packages/server/utils/passwordPolicy.js`
    - `npm -w @wsm/server run test`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.6 validation checkpoint:
  - Backend smoke scripts executed successfully against current staging runtime.
  - Results:
    - `npm -w @wsm/server run smoke:rbac` -> PASS
    - `npm -w @wsm/server run smoke:integrity` -> PASS (mutation/reception/cash optional flows skipped by env flags)
- P2.6 partial progress (backend session hardening):
  - Added token revocation by server-side `token_version`:
    - JWT now includes `token_version` claim at login.
    - `authenticateToken` now checks current user status and token_version in DB.
    - password change and user deactivation rotate token version to revoke active sessions.
  - Added migration:
    - `packages/server/migrations/003_add_user_token_version.sql`
  - Files:
    - `packages/server/controllers/userController.js`
    - `packages/server/middleware/authMiddleware.js`
    - `packages/server/migrations/003_add_user_token_version.sql`
  - Validation:
    - `node --check packages/server/controllers/userController.js`
    - `node --check packages/server/middleware/authMiddleware.js`
    - `npm -w @wsm/server run test`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- Incident hotfix (staging availability):
  - Root cause:
    - global `/api` rate-limit too aggressive for real navigation in staging (`100` req/15m),
      causing broad `429 too_many_requests` and empty screens.
  - Mitigation:
    - rate limits now configurable via env
    - safer defaults by environment (dev/staging higher, production controlled)
    - `/api/health` excluded from limiter
    - login limiter preserved separately and configurable
  - Files:
    - `packages/server/index.js`
    - `packages/server/config/env.js`
    - `.env.example`
  - Validation:
    - server syntax checks + frontend typecheck/build passed.
- P2.6 partial progress (frontend credential hardening):
  - Politica de contrasena fuerte alineada en frontend con backend.
  - Se agrego helper reutilizable de politica de contrasena para evitar duplicacion.
  - `UserForm` ahora valida complejidad desde cliente con:
    - `minLength=8`, `maxLength=128`
    - `pattern` de mayuscula/minuscula/numero/simbolo
    - texto de ayuda consistente para usuario operador
  - Files:
    - `packages/client/src/lib/passwordPolicy.ts`
    - `packages/client/src/components/users/UserForm.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/components/users/UserForm.tsx src/lib/passwordPolicy.ts`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.6 validation checkpoint (smoke backend full):
  - Re-run smoke validation completed in staging with previous rate-limit blocker resolved.
  - Results:
    - `npm -w @wsm/server run smoke:rbac` -> PASS
    - `npm -w @wsm/server run smoke:integrity` -> PASS
    - `SMOKE_MUTATION=1 SMOKE_RECEPTION_FLOW=1 SMOKE_CASH_FLOW=1 npm -w @wsm/server run smoke:integrity` -> PASS
  - Notes:
    - Full integrity run validated soft-delete, reception approval idempotency and cash balance invariants.
- P2.6 partial progress (UX language consistency):
  - Normalized visible labels to Spanish AR in key operational screens.
  - Updated terms:
    - `Manager` -> `Gerencia`
    - `Close` (screen reader) -> `Cerrar`
    - `Email` labels/headers/actions -> `Correo` / `Correo electronico`
  - Files:
    - `packages/client/src/components/users/UserForm.tsx`
    - `packages/client/src/components/ui/dialog.tsx`
    - `packages/client/src/pages/Clients.tsx`
    - `packages/client/src/pages/Suppliers.tsx`
    - `packages/client/src/pages/Settings.tsx`
  - Validation:
    - `npm -w @wsm/client exec eslint src/components/users/UserForm.tsx src/components/ui/dialog.tsx src/pages/Clients.tsx src/pages/Suppliers.tsx src/pages/Settings.tsx`
    - `npm -w @wsm/client exec -- tsc --noEmit`
    - `npm -w @wsm/client run build`
- P2.7 partial progress (combined hardening batch):
  - Backend data integrity and auth hardening:
    - `transitionOrderStatus` ahora opera en transaccion y restaura stock al cancelar ordenes.
    - endurecimiento RBAC para notas de credito manuales (`admin|manager`).
    - bootstrap de admin sin password por defecto ni log de credenciales; exige `ADMIN_DEFAULT_PASSWORD` robusta.
  - Backend maintainability:
    - `getRequestIp` centralizado en util unico y removida duplicacion en 8 controllers.
  - Frontend UX/navigation:
    - ruta 404 agregada con pagina dedicada.
    - normalizado import alias de `Receptions` en `App.tsx`.
  - Frontend lint stabilization:
    - `PurchaseOrderDetails` con `useCallback`/deps estables.
    - ajustes lint en componentes UI (`badge`, `button`, `form`, `input`, `textarea`).
  - Files:
    - `packages/server/services/sales.service.js`
    - `packages/server/routes/warrantiesRoutes.js`
    - `packages/server/config/initDb.js`
    - `packages/server/utils/requestIp.js`
    - `packages/server/controllers/inventoryController.js`
    - `packages/server/controllers/salesController.js`
    - `packages/server/controllers/procurementController.js`
    - `packages/server/controllers/financeController.js`
    - `packages/server/controllers/settingsController.js`
    - `packages/server/controllers/supplierController.js`
    - `packages/server/controllers/userController.js`
    - `packages/server/controllers/warrantiesController.js`
    - `packages/client/src/App.tsx`
    - `packages/client/src/pages/NotFound.tsx`
    - `packages/client/src/components/purchase-orders/PurchaseOrderDetails.tsx`
    - `packages/client/src/components/ui/badge.tsx`
    - `packages/client/src/components/ui/button.tsx`
    - `packages/client/src/components/ui/form.tsx`
    - `packages/client/src/components/ui/input.tsx`
    - `packages/client/src/components/ui/textarea.tsx`
  - Validation:
    - `npm -w @wsm/server run test`
    - `npm -w @wsm/server run smoke:rbac`
    - `npm -w @wsm/server run smoke:integrity`
    - `npm -w @wsm/client run lint`
    - `npm -w @wsm/client run test`
    - `npm -w @wsm/client run build`
- P2.7 partial progress (repository hygiene):
  - Removed tracked recovery artifacts `*.corrupt.bak` from active frontend source tree.
  - Added guardrail in `.gitignore` to prevent re-committing `*.corrupt.bak` files.
  - Validation:
    - `npm -w @wsm/client run build`
- P2.7 partial progress (scalability pagination baseline):
  - Added backward-compatible pagination support (`page`, `limit`, `offset`) in high-volume endpoints:
    - `GET /api/orders`
    - `GET /api/products`
    - `GET /api/settings/audit-logs`
  - Response body contract remains backward-compatible (still arrays).
  - When pagination params are present, API now emits metadata headers:
    - `X-Total-Count`, `X-Page`, `X-Limit`, `X-Total-Pages`
  - Backend shared utility added:
    - `packages/server/utils/pagination.js`
  - Validation schema updated for paginated filters:
    - `orderFilters`, `productFilters`, `auditLogsFilters`
  - Services extended with optional `includeTotal` + `limit/offset`:
    - `packages/server/services/sales.service.js`
    - `packages/server/services/inventory.service.js`
    - `packages/server/services/audit.service.js`
  - Controllers wired for pagination and headers:
    - `packages/server/controllers/salesController.js`
    - `packages/server/controllers/inventoryController.js`
    - `packages/server/controllers/settingsController.js`
  - Client API typings expanded (no contract break):
    - `packages/client/src/services/api.ts`
  - Validation:
    - `npm -w @wsm/server run test` (PASS)
    - `npm -w @wsm/client run lint` (PASS)
    - `npm -w @wsm/client run test` (PASS)
    - `npm -w @wsm/client run build` (PASS)
  - Environment limitation:
    - `smoke:rbac` / `smoke:integrity` cannot complete in current Codex runtime due local fetch restrictions (`fetch failed` from Node process), despite `api/health` reachable from host shell.
- P2.8 partial progress (frontend pagination adoption):
  - Added client-side pagination metadata contract:
    - `PaginationMeta` / `PaginatedResponse` in shared API types.
  - Extended HTTP layer to read backend pagination headers:
    - `httpClient.getWithMeta(...)` parses `X-Total-Count`, `X-Page`, `X-Limit`, `X-Total-Pages`.
  - Added reusable UI controls:
    - `packages/client/src/components/common/PaginationControls.tsx`.
  - Orders page now uses server pagination (`20` rows/page) with filter-aware query keys:
    - `packages/client/src/pages/Orders.tsx`
    - `packages/client/src/lib/queryKeys.ts`
  - Inventory page now consumes paginated products snapshot with preserved stock immobilization logic:
    - `packages/client/src/lib/inventorySnapshot.ts`
    - `packages/client/src/pages/Inventory.tsx`
  - Settings page audit tab now loads paginated logs (`20` rows/page) with dedicated loading state:
    - `packages/client/src/pages/Settings.tsx`
  - API service expanded with explicit paged methods (backward compatible):
    - `getOrdersPage`, `getProductsPage`, `getAuditLogsPage` in `packages/client/src/services/api.ts`
  - Validation:
    - `npm -w @wsm/server run test`
    - `npm -w @wsm/client run lint`
    - `npm -w @wsm/client run test`
    - `npm -w @wsm/client run build`
- P2.8 partial progress (language consistency pass):
  - Normalized residual user-facing wording to Spanish in core auth/http/settings flows:
    - translated fallback/validation messages in auth context (`login`/`useAuth`).
    - translated generic HTTP fallback from `HTTP Error` to `Error HTTP`.
    - replaced `Website` label by `Sitio web` in settings company form.
  - Files:
    - `packages/client/src/context/AuthContext.tsx`
    - `packages/client/src/services/httpClient.ts`
    - `packages/client/src/pages/Settings.tsx`
  - Validation:
    - `npm -w @wsm/server run test`
    - `npm -w @wsm/client run lint`
    - `npm -w @wsm/client run test`
    - `npm -w @wsm/client run build`

## Next After Current Task
P2.8 continuation - validacion funcional en staging de paginacion UI + plan operativo de rotacion de secretos.

## Open Decisions (Need confirmation for upcoming blocks)
1. Stock policy (implemented assumption):
   - Applied Option A: deduct at order creation.
   - If business prefers reservation model, refactor in a dedicated pass.
2. Stock source of truth (resolved):
   - Canonical source: `inventory` table.
   - Compatibility contract: `/api/products` exposes derived `stock_current`.
3. Non-dev exception policy:
   - `ALLOW_INSECURE_NON_DEV=true` remains available as explicit break-glass override.
   - Default policy is strict fail-fast in staging/production.
