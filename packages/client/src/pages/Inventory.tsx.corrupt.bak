�import { useState, useEffect } from "react"
import {
    useReactTable,
    getCoreRowModel,
    getPaginationRowModel,
    getFilteredRowModel,
    flexRender,
    type ColumnDef,
    type SortingState,
    getSortedRowModel
} from "@tanstack/react-table"
import { ArrowUpDown, Pencil, Plus, Box, Trash2 } from "lucide-react"
import { cn } from "@/lib/utils"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Badge } from "@/components/ui/badge"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog"
import { ProductForm } from "@/components/products/ProductForm"
import { api } from "@/services/api"
import { showErrorToast } from "@/lib/errorHandling"
import type { Order, Product } from "@/types"
import { toast } from "sonner"
import { TableSkeleton } from "@/components/common/Skeletons" ? export type ProductWithStock = Product & { stock_available : number, stock_immobilized: number }

export default function InventoryPage() {
    const [data, setData] = useState<ProductWithStock[]>([])
    const [loading, setLoading] = useState(true)
    const [sorting, setSorting] = useState<SortingState>([])
    const [globalFilter, setGlobalFilter] = useState("")
    const [isDialogOpen, setIsDialogOpen] = useState(false)
    const [deletingProduct, setDeletingProduct] = useState<ProductWithStock | null>(null)

    const [editingProduct, setEditingProduct] = useState<ProductWithStock | undefined>(undefined)

    const loadData = async () => {
        try {
            const [products, orders] = await Promise.all([
                api.getProducts(),
                api.getOrders()
            ]) ? const merged = products.map((product : Product) => {
                const immobilized = orders ? .filter((order : Order) => order.status === "pending" || order.status === "picking") ? .flatMap((order : Order) => order.items)
                    .filter((item) => item.product_id === product.id)
                    .reduce((sum, item) => sum + Number(item.quantity || 0), 0)

                return {
                    ...product,
                    // Canonical stock source is inventory, exposed by /api/products as stock_current. ? stock_available : Number(product.stock_current || 0), ? stock_immobilized : immobilized
                }
            })

            setData(merged)
        } catch (error) {
            showErrorToast("Error al cargar inventario", error)
        } finally {
            setLoading(false)
        }
    }

    useEffect(() => {
        void loadData()
    }, []) ? const handleSaveProduct = async (productData : Omit<Product, "id" | "created_at" | "description" | "image_url">) => {
        try {
            if (editingProduct) {
                // Update existing product
                await api.updateProduct(editingProduct.id, {
                    ...productData, ? description : editingProduct.description || "", ? image_url : editingProduct.image_url || ""
                }) ? toast.success("Producto actualizado", { description : `${productData.name} ha sido actualizado correctamente.` })
            } else {
                // Create new product
                await api.createProduct({
                    ...productData, ? description : "", ? image_url : ""
                }) ? toast.success("Producto creado", { description : `${productData.name} ha sido agregado correctamente.` })
            }
            void loadData()
            setIsDialogOpen(false)
            setEditingProduct(undefined)
        } catch (error) { ? showErrorToast(editingProduct  "Error al actualizar producto" : "Error al crear producto", error)
        }
    }

    const handleDeleteProduct = async () => {
        if (!deletingProduct) return
        try {
            await api.deleteProduct(deletingProduct.id) ? toast.success("Producto eliminado", { description : `${deletingProduct.name} ha sido eliminado correctamente.` })
            setDeletingProduct(null)
            void loadData()
        } catch (error) {
            showErrorToast("Error al eliminar producto", error)
            setDeletingProduct(null)
        }
    } ? const openEditDialog = (product : ProductWithStock) => {
        setEditingProduct(product)
        setIsDialogOpen(true)
    }

    const openCreateDialog = () => {
        setEditingProduct(undefined)
        setIsDialogOpen(true)
    }
    // ...
    // ... existing columns definition (unchanged) ...
    // Keep lines 34-106 as is, or I need to be careful with range.
    // I will just replace the top part and then the render part.
    // The tool requires contiguous block. I'll replace the full component start up to return. ? const columns : ColumnDef<ProductWithStock>[] = [
        { ? accessorKey : "sku", ? header : "SKU", ? cell : ({ row }) => <span className="font-mono text-xs">{row.getValue("sku")}</span>
        },
        { ? accessorKey : "name", ? header : ({ column }) => {
                return (
                    <Button
                        variant="ghost"
                        onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}
                    >
                        Producto
                        <ArrowUpDown className="ml-2 h-4 w-4" />
                    </Button>
                )
            },
        },
        { ? accessorKey : "category", ? header : "Categoría", ? cell : ({ row }) => <Badge variant="secondary">{row.getValue("category")}</Badge>
        },
        { ? accessorKey : "purchase_price", ? header : "P. Compra", ? cell : ({ row }) => {
                const amount = parseFloat(row.getValue("purchase_price"))
                return new Intl.NumberFormat("en-US", { ? style : "currency", ? currency : "USD",
                }).format(amount)
            },
        },
        { ? accessorKey : "sale_price", ? header : "P. Venta", ? cell : ({ row }) => {
                const amount = parseFloat(row.getValue("sale_price"))
                return <span className="font-bold text-green-500">{new Intl.NumberFormat("en-US", { ? style : "currency", ? currency : "USD",
                }).format(amount)}</span>
            },
        },
        { ? accessorKey : "stock_available", ? header : "Disponible", ? cell : ({ row }) => (
                <div className="flex items-center gap-1"> ? <div className={cn("h-2 w-2 rounded-full", (row.original.stock_available || 0) > 0  "bg-green-500" : "bg-red-500")} />
                    <span className="font-bold">{row.original.stock_available}</span>
                </div>
            )
        },
        { ? accessorKey : "stock_immobilized", ? header : "Inmovilizado", ? cell : ({ row }) => (
                <div className="flex items-center gap-1 text-orange-500" title="Stock en órdenes pendientes">
                    {(row.original.stock_immobilized || 0) > 0 && <Box className="h-3 w-3" />}
                    <span className="font-mono">{row.original.stock_immobilized}</span>
                </div>
            )
        },
        { ? id : "location", ? header : "Ubicación", ? cell : ({ row }) => {
                const location = row.original.location || 'Sin Asignar'

                return (
                    <Badge
                        variant="outline" ? className={location === 'Sin Asignar'  'border-gray-500/50 text-gray-400 bg-gray-500/10' : 'border-blue-500/50 text-blue-400 bg-blue-500/10 hover:bg-blue-500/20'}
                    >
                        {location}
                    </Badge>
                )
            }
        },
        { ? id : "actions", ? header : "Acciones", ? cell : ({ row }) => (
                <div className="flex gap-2">
                    <Button variant="ghost" size="sm" onClick={() => openEditDialog(row.original)} title="Editar Producto">
                        <Pencil className="h-4 w-4 text-blue-400" />
                    </Button> ? <Button variant="ghost" size="sm" onClick={() => setDeletingProduct(row.original)} title="Eliminar Producto" className="text-red-400 hover :text-red-300 hover:bg-red-950">
                        <Trash2 className="h-4 w-4" />
                    </Button>
                </div>
            )
        },
    ]

    const table = useReactTable({
        data,
        columns, ? getCoreRowModel : getCoreRowModel(), ? getPaginationRowModel : getPaginationRowModel(), ? getSortedRowModel : getSortedRowModel(), ? getFilteredRowModel : getFilteredRowModel(), ? onSortingChange : setSorting, ? onGlobalFilterChange : setGlobalFilter, ? state : {
            sorting,
            globalFilter,
        },
    })

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex items-center justify-between">
                <div>
                    <h2 className="text-3xl font-bold tracking-tight">Inventario</h2>
                    <p className="text-muted-foreground">Gestiona tu catálogo de productos y existencias.</p>
                </div>
                <Dialog open={isDialogOpen} onOpenChange={(open) => {
                    setIsDialogOpen(open)
                    if (!open) setEditingProduct(undefined)
                }}>
                    <DialogTrigger asChild>
                        <Button className="gap-2" onClick={openCreateDialog}>
                            <Plus className="h-4 w-4" /> Nuevo Producto
                        </Button>
                    </DialogTrigger>
                    <DialogContent>
                        <DialogHeader> ? <DialogTitle>{editingProduct  'Editar Producto' : 'Agregar Nuevo Producto'}</DialogTitle>
                            <DialogDescription> ? {editingProduct  'Modifica los detalles del producto seleccionado.' : 'Completa los detalles del producto para añadirlo al inventario.'}
                            </DialogDescription>
                        </DialogHeader>
                        <ProductForm
                            onSubmit={handleSaveProduct}
                            onCancel={() => setIsDialogOpen(false)} ? {...(editingProduct  { initialData : editingProduct } : {})}
                        />
                    </DialogContent>
                </Dialog>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle>Productos</CardTitle>
                    <CardDescription>
                        {data.length} productos registrados en el sistema.
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="flex items-center py-4">
                        <Input
                            placeholder="Filtrar productos..."
                            value={globalFilter  ""}
                            onChange={(event) => setGlobalFilter(event.target.value)}
                            className="max-w-sm"
                        />
                    </div>
                    {loading  (
                        <TableSkeleton columns={columns.length} rows={10} /> ? ) : (
                        <div className="rounded-md border">
                            <Table>
                                <TableHeader>
                                    {table.getHeaderGroups().map((headerGroup) => (
                                        <TableRow key={headerGroup.id}>
                                            {headerGroup.headers.map((header) => {
                                                return (
                                                    <TableHead key={header.id}>
                                                        {header.isPlaceholder ? null : flexRender(
                                                                header.column.columnDef.header,
                                                                header.getContext()
                                                            )}
                                                    </TableHead>
                                                )
                                            })}
                                        </TableRow>
                                    ))}
                                </TableHeader>
                                <TableBody>
                                    {table.getRowModel().rows.length  (
                                        table.getRowModel().rows.map((row) => (
                                            <TableRow
                                                key={row.id}
                                                data-state={row.getIsSelected() && "selected"}
                                            >
                                                {row.getVisibleCells().map((cell) => (
                                                    <TableCell key={cell.id}>
                                                        {flexRender(
                                                            cell.column.columnDef.cell,
                                                            cell.getContext()
                                                        )}
                                                    </TableCell>
                                                ))}
                                            </TableRow>
                                        )) ? ) : (
                                        <TableRow>
                                            <TableCell
                                                colSpan={columns.length}
                                                className="h-24 text-center"
                                            > ? {loading  "Cargando datos..." : "No se encontraron resultados."}
                                            </TableCell>
                                        </TableRow>
                                    )}
                                </TableBody>
                            </Table>
                        </div>
                    )}
                    <div className="flex items-center justify-end space-x-2 py-4">
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => table.previousPage()}
                            disabled={!table.getCanPreviousPage()}
                        >
                            Anterior
                        </Button>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => table.nextPage()}
                            disabled={!table.getCanNextPage()}
                        >
                            Siguiente
                        </Button>
                    </div>
                </CardContent>
            </Card>

            {/* Delete Confirmation Dialog */}
            {deletingProduct && (
                <DeleteProductDialog
                    product={deletingProduct}
                    open={!!deletingProduct} ? onOpenChange={(open : boolean) => !open && setDeletingProduct(null)}
                    onConfirm={handleDeleteProduct}
                />
            )}
        </div>
    )
} ? function DeleteProductDialog({ product, open, onOpenChange, onConfirm } : { product: ProductWithStock, open: boolean, onOpenChange: (open: boolean) => void, onConfirm: () => void }) {
    return (
        <Dialog open={open} onOpenChange={onOpenChange}> ? <DialogContent className="sm :max-w-[425px]">
                <DialogHeader>
                    <DialogTitle className="text-red-400">¿Eliminar Producto</DialogTitle>
                    <DialogDescription> ? Esta acción eliminará permanentemente el producto <strong>{product.name}</strong> (SKU : {product.sku}).
                        {product.stock_available > 0 && (
                            <span className="block mt-2 text-yellow-400"> ? Advertencia : Este producto tiene {product.stock_available} unidades en inventario
                            </span>
                        )}
                    </DialogDescription>
                </DialogHeader>
                <DialogFooter className="gap-2">
                    <Button variant="outline" onClick={() => onOpenChange(false)}>Cancelar</Button> ? <Button variant="destructive" onClick={onConfirm} className="bg-red-600 hover :bg-red-500">
                        <Trash2 className="h-4 w-4 mr-2" />
                        Eliminar Producto
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}

