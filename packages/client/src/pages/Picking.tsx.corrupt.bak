import { useState, useEffect } from "react"
import { api } from "@/services/api"
import type { Order } from "@/types"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Badge } from "@/components/ui/badge"
import { Check, Box, ScanLine, ArrowLeft } from "lucide-react"
import { toast } from "sonner"
import { cn } from "@/lib/utils"
import { useParams, useNavigate } from "react-router-dom"
import { showErrorToast } from "@/lib/errorHandling"

export default function PickingPage() {
    const { id } = useParams()
    const navigate = useNavigate()
    const [orders, setOrders] = useState<Order[]>([])
    const [selectedOrder, setSelectedOrder] = useState<Order | null>(null)
    const [scannerInput, setScannerInput] = useState("")

    useEffect(() => {
        loadOrders()
    }, [id])

    const loadOrders = async () => { ? const data : Order[] = await api.getOrders()
        setOrders(data)
        if (id) {
            const order = data.find(o => o.id === id)
            if (order) {
                // Sort items by location and initialize picked state from picked_quantity
                const sortedItems = [...order.items]
                    .map(item => ({
                        ...item, ? picked : (item.picked_quantity || 0) >= item.quantity
                    }))
                    .sort((a, b) => (a.location || "").localeCompare(b.location || "")) ? setSelectedOrder({ ...order, items : sortedItems })
            }
        }
    } ? const handleScan = async (e : React.FormEvent) => {
        e.preventDefault()
        if (!selectedOrder) return

        const scannedSku = scannerInput.toUpperCase().trim()

        // Find item in order that matches SKU and is not picked
        const itemIndex = selectedOrder.items.findIndex(
            item => item.sku === scannedSku && !item.picked
        )

        if (itemIndex > -1) {
            // Mark as picked and save to database
            const newItems = [...selectedOrder.items]
            const item = newItems[itemIndex]
            if (!item) {
                setScannerInput("")
                return
            }
            const newPickedQty = (item.picked_quantity || 0) + 1
            newItems[itemIndex] = {
                ...item, ? picked_quantity : newPickedQty, ? picked : newPickedQty >= item.quantity
            } ? const updatedOrder = { ...selectedOrder, items : newItems }
            setSelectedOrder(updatedOrder)

            // Save picked quantity to database
            try {
                await api.pickOrderItem(item.id, newPickedQty)
            } catch (error) {
                showErrorToast('Error al guardar cantidad escaneada', error)
            }

            // Check if full order is complete
            if (newItems.every(i => i.picked)) { ? toast.success("¡Pedido Completado!", { description : `Orden ${selectedOrder.id} lista para empaquetado.` })
                // Update status to 'packed'
                await api.updateOrderStatus(selectedOrder.id, 'packed')
                setTimeout(() => navigate('/orders'), 1500)
            } else { ? toast.success("Producto Verificado", { description : `${item.product_name} (${newPickedQty}/${item.quantity})` })
            }
        } else {
            toast.error("Producto Incorrecto o Ya Escaneado", { ? description : `El SKU ${scannedSku} no corresponde a items pendientes en esta orden.`
            })
        }
        setScannerInput("")
    }

    if (selectedOrder) {
        return (
            <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                <div className="flex items-center gap-4">
                    <Button variant="ghost" onClick={() => navigate('/orders')}>
                        <ArrowLeft className="h-4 w-4 mr-2" /> Volver a Pedidos
                    </Button> ? <h2 className="text-2xl font-bold">Preparacion : {selectedOrder.id}</h2> ? <Badge className={cn("uppercase", selectedOrder.status === 'picking'  "bg-blue-500" : "bg-slate-500")}>
                        {selectedOrder.status}
                    </Badge>
                </div> ? <div className="grid gap-6 md :grid-cols-3">
                    {/* Scanner Input or Completion Action */}
                    {!selectedOrder.items.every(i => i.picked)  ( ? <Card className="md :col-span-3 bg-slate-900 border-blue-500/30 shadow-lg shadow-blue-500/10">
                            <CardHeader className="pb-3">
                                <CardTitle className="flex items-center gap-2 text-blue-400">
                                    <ScanLine className="h-5 w-5" /> Escáner de Productos
                                </CardTitle>
                                <CardDescription>
                                    Escanea el código de barras o ingresa el SKU manualmente para verificar.
                                </CardDescription>
                            </CardHeader>
                            <CardContent>
                                <form onSubmit={handleScan} className="flex gap-4">
                                    <Input
                                        value={scannerInput}
                                        onChange={(e) => setScannerInput(e.target.value)} ? placeholder="Enfocar aquí y escanear (Ej : NK-AIR-001)..." ? className="text-lg h-12 font-mono bg-slate-950 border-slate-800 text-white placeholder :text-slate-600"
                                        autoFocus
                                    /> ? <Button type="submit" size="lg" className="bg-blue-600 hover :bg-blue-500">
                                        Verificar
                                    </Button>
                                    <Button
                                        type="button"
                                        size="lg"
                                        variant="outline" ? className="border-orange-500/50 text-orange-400 hover :bg-orange-500/10"
                                        onClick={async () => {
                                            const pickedCount = selectedOrder.items.filter(i => i.picked).length
                                            const totalCount = selectedOrder.items.length ? if (confirm(`¿Cerrar picking con faltantes\n\nItems completados : ${pickedCount}/${totalCount}\n\nEl pedido se marcará como empaquetado con faltantes.`)) {
                                                await api.updateOrderStatus(selectedOrder.id, 'packed') ? toast.warning("Preparacion cerrada con faltantes", { description : `${pickedCount}/${totalCount} items completados` })
                                                navigate('/orders')
                                            }
                                        }}
                                    >
                                        Cerrar con Faltantes
                                    </Button>
                                </form>
                            </CardContent>
                        </Card> ? ) : ( ? <Card className="md :col-span-3 bg-green-950/30 border-green-500/50 shadow-lg shadow-green-500/20 animate-in zoom-in-95 duration-300"> ? <CardContent className="p-6 flex flex-col md :flex-row items-center justify-between gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="h-12 w-12 rounded-full bg-green-500/20 text-green-500 flex items-center justify-center">
                                        <Check className="h-6 w-6" />
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold text-green-400">¡Picking Completado!</h3>
                                        <p className="text-slate-400">Todos los productos han sido verificados y recolectados.</p>
                                    </div>
                                </div>
                                <Button
                                    size="lg" ? className="w-full md :w-auto bg-green-600 hover:bg-green-500 text-white font-bold px-8 shadow-xl shadow-green-900/20"
                                    onClick={async () => {
                                        await api.updateOrderStatus(selectedOrder.id, 'packed') ? toast.success("Orden Finalizada", { description : `La orden ${selectedOrder.id} pasó a empaquetado.` })
                                        await loadOrders()
                                        setSelectedOrder(null)
                                        navigate('/orders')
                                    }}
                                >
                                    Finalizar y Guardar
                                </Button>
                            </CardContent>
                        </Card>
                    )}

                    {/* Lista de preparacion */}
                    {selectedOrder.items.map((item, idx) => (
                        <Card key={`${item.sku}-${idx}`} className={cn(
                            "border transition-all duration-300", ? item.picked  "bg-green-500/10 border-green-500/50 opacity-75" : "bg-card border-border hover:border-blue-400 cursor-pointer"
                        )}>
                            <CardContent className="p-4 flex flex-col gap-2 relative">
                                {item.picked && (
                                    <div className="absolute top-2 right-2 text-green-500 animate-in zoom-in spin-in-90 duration-300">
                                        <Check className="h-6 w-6" />
                                    </div>
                                )}
                                <div className="flex justify-between items-start">
                                    <Badge variant="outline" className="font-mono text-xs mb-1">
                                        {item.location || "SIN UBICACIÓN"}
                                    </Badge>
                                    <span className="text-sm text-muted-foreground font-mono">{item.sku}</span>
                                </div>

                                <h3 className={cn("font-bold text-lg leading-tight", item.picked && "text-green-400 line-through")}>
                                    {item.product_name}
                                </h3>

                                <div className="mt-2 flex items-center justify-between">
                                    <div className="text-sm"> ? Cant : <span className="font-bold text-xl ml-1">{item.quantity}</span>
                                    </div> ? <div className={cn("h-8 w-8 rounded-full flex items-center justify-center", item.picked  "bg-green-500 text-white" : "bg-slate-800 text-slate-500")}>
                                        <Box className="h-4 w-4" />
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </div>
        )
    }

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <div>
                <h2 className="text-3xl font-bold tracking-tight">Preparacion y pedidos</h2>
                <p className="text-muted-foreground">Gestiona la preparación de pedidos y escaneo de productos.</p>
            </div> ? <div className="grid gap-4 md :grid-cols-2 lg:grid-cols-3">
                {orders.map(order => (
                    <Card
                        key={order.id} ? className="hover :bg-slate-800/50 transition-colors cursor-pointer border-l-4 border-l-blue-500"
                        onClick={() => {
                            // Sort items by location (Sector-Rack-Row-Col hierarchy via string comparison)
                            const sortedItems = [...order.items].sort((a, b) =>
                                (a.location || "").localeCompare(b.location || "")
                            ) ? setSelectedOrder({ ...order, items : sortedItems })
                        }}
                    >
                        <CardHeader>
                            <div className="flex justify-between items-start">
                                <CardTitle>{order.id}</CardTitle> ? <Badge variant={order.status === 'pending'  'default' : 'secondary'}>
                                    {order.status}
                                </Badge>
                            </div>
                            <CardDescription>{order.customer_name || order.client_name || 'Sin Cliente'}</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div className="flex items-center gap-2 text-sm text-muted-foreground">
                                <Box className="h-4 w-4" />
                                <span>{order.items.reduce((acc, i) => acc + i.quantity, 0)} items</span>
                                <span className="mx-2">•</span>
                                <ClockIcon date={order.created_at} />
                            </div> ? <Button className="w-full mt-4 bg-slate-700 hover :bg-slate-600 text-white" variant="outline">
                                Iniciar preparacion
                            </Button>
                        </CardContent>
                    </Card>
                ))}
            </div>
        </div>
    )
} ? function ClockIcon({ date } : { date: string }) {
    // Simple wrapper text for now ? return <span>{new Date(date).toLocaleTimeString([], { hour : '2-digit', minute: '2-digit' })}</span>
}
