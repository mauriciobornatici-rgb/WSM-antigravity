import { useState, useEffect } from "react"
import { api } from "@/services/api"
import type { Order, Product, Client, CompanySettings } from "@/types"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog"
import { Badge } from "@/components/ui/badge"
import { Plus, Search, ShoppingCart, Package, CheckCircle2, CircleDashed, Truck, FileText, MoreHorizontal, XCircle } from "lucide-react"
import type { LucideIcon } from "lucide-react"
import { Label } from "@/components/ui/label"
import { toast } from "sonner"
import { useNavigate } from "react-router-dom"
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu"
import { showErrorToast } from "@/lib/errorHandling"
import {
    DEFAULT_COMPANY_SETTINGS,
    fetchCompanySettingsSafe,
    getCompanyAddressLine,
    getCompanyDisplayName,
} from "@/lib/companySettings"
export default function OrdersPage() {
    const navigate = useNavigate()
    const [orders, setOrders] = useState<Order[]>([])
    const [products, setProducts] = useState<Product[]>([])
    const [clients, setClients] = useState<Client[]>([])
    const [companySettings, setCompanySettings] = useState<CompanySettings>(DEFAULT_COMPANY_SETTINGS)
    const [isCreateOpen, setIsCreateOpen] = useState(false)
    const [statusFilter, setStatusFilter] = useState<string | null>(null)

    // Dispatch/Delivery Dialog State
    const [dispatchDialogOpen, setDispatchDialogOpen] = useState(false)
    const [deliverDialogOpen, setDeliverDialogOpen] = useState(false)
    const [selectedOrderForAction, setSelectedOrderForAction] = useState<Order | null>(null)
    const [shippingMethod, setShippingMethod] = useState<'pickup' | 'delivery'>('delivery')
    const [trackingNumber, setTrackingNumber] = useState('')
    const [estimatedDelivery, setEstimatedDelivery] = useState('')
    const [shippingAddress, setShippingAddress] = useState('')
    const [recipientName, setRecipientName] = useState('')
    const [recipientDni, setRecipientDni] = useState('')
    const [deliveryNotes, setDeliveryNotes] = useState('')
    const [orderToPrint, setOrderToPrint] = useState<Order | null>(null)
    const [printType, setPrintType] = useState<'detail' | 'remito'>('detail') ? const printOrder = (order : Order, type: 'detail' | 'remito' = 'detail') => {
        setOrderToPrint(order)
        setPrintType(type)
        setTimeout(() => window.print(), 100)
    } ? const formatDate = (dateStr : string | undefined) => {
        if (!dateStr) return '-' ? return new Date(dateStr).toLocaleDateString('es-AR', { day : '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
    } ? const getStatusLabel = (status : string) => { ? const labels : Record<string, string> = { ? pending : 'Pendiente', ? picking : 'En preparacion', ? packed : 'Empaquetado', ? dispatched : 'Despachado', ? delivered : 'Entregado', ? completed : 'Completado', ? cancelled : 'Cancelado'
        }
        return labels[status] || status
    }

    // Invoice state
    const [invoiceDialogOpen, setInvoiceDialogOpen] = useState(false)
    const [orderToInvoice, setOrderToInvoice] = useState<Order | null>(null) ? const [invoicePayments, setInvoicePayments] = useState<{ method : string, amount: number }[]>([]) ? const calculateTotalToPay = (order : Order) => {
        return order.items
            .filter(i => (i.picked_quantity || 0) > 0)
            .reduce((sum, i) => sum + (i.picked_quantity || 0) * Number(i.unit_price), 0)
    } ? const openInvoiceDialog = (order : Order) => {
        const total = calculateTotalToPay(order)
        setOrderToInvoice(order) ? setInvoicePayments([{ method : 'cash', amount: total }]) // Start with full amount in cash
        setInvoiceDialogOpen(true)
    }

    const addPaymentMethod = () => { ? setInvoicePayments([...invoicePayments, { method : 'cash', amount: 0 }])
    } ? const updatePayment = (index : number, field: 'method' | 'amount', value: string | number) => {
        const updated = [...invoicePayments]
        const payment = updated[index]
        if (!payment) return

        if (field === 'method') {
            payment.method = value as string
        } else {
            payment.amount = Number(value)
        }
        setInvoicePayments(updated)
    } ? const removePayment = (index : number) => {
        setInvoicePayments(invoicePayments.filter((_, i) => i !== index))
    }

    async function loadData() {
        try {
            const [ordersData, productsData, clientsData, settingsData] = await Promise.all([
                api.getOrders(),
                api.getProducts(),
                api.getClients(),
                fetchCompanySettingsSafe(),
            ])
            setOrders(ordersData)
            setProducts(productsData)
            setClients(clientsData)
            setCompanySettings(settingsData)
        } catch (error) {
            showErrorToast("Error al cargar pedidos", error)
        }
    }

    useEffect(() => {
        const timer = window.setTimeout(() => {
            void loadData()
        }, 0)
        return () => window.clearTimeout(timer)
    }, [])

    const handleCreateInvoice = async () => {
        if (!orderToInvoice) return
        const totalToPay = calculateTotalToPay(orderToInvoice)
        const totalPayments = invoicePayments.reduce((sum, p) => sum + p.amount, 0)

        if (Math.abs(totalPayments - totalToPay) > 0.01) { ? toast.error("Error", { description : `El total de pagos ($${totalPayments.toLocaleString()}) no coincide con el monto a cobrar ($${totalToPay.toLocaleString()})` })
            return
        }

        try {
            const data = await api.createInvoiceFromOrder(orderToInvoice.id, { ? payments : invoicePayments, ? notes : ''
            }) ? toast.success("Factura Creada", { description : `N ${data.invoice_number} - $${Number(data.total_amount).toLocaleString()}` })
            setInvoiceDialogOpen(false)
            void loadData()
        } catch (error) {
            showErrorToast("Error al facturar", error)
        }
    }

    const companyName = getCompanyDisplayName(companySettings)
    const companyAddress = getCompanyAddressLine(companySettings) ? const handleCreateOrder = async (customer : string, items: { product: Product, quantity: number }[], clientId: string) => { ? const payload : Parameters<typeof api.createOrder>[0] = { ? customer_name : customer, ? total_amount : items.reduce((sum, i) => sum + (i.product.sale_price * i.quantity), 0), ? items : items.map(i => ({ product_id: i.product.id, quantity: i.quantity })), ? transaction_type : 'pending'
        }

        if (clientId) {
            payload.client_id = clientId
        }

        await api.createOrder(payload)
        await loadData()
        setIsCreateOpen(false) ? toast.success("Pedido Creado", { description : "Stock validado y descontado. La orden esta lista para preparacion." })
    } ? const openDispatchDialog = (order : Order) => {
        setSelectedOrderForAction(order)
        setShippingMethod('delivery')
        setTrackingNumber('')
        setEstimatedDelivery('')
        setShippingAddress(order.shipping_address || '')
        setDispatchDialogOpen(true)
    } ? const openDeliverDialog = (order : Order) => {
        setSelectedOrderForAction(order)
        setRecipientName('')
        setRecipientDni('')
        setDeliveryNotes('')
        setDeliverDialogOpen(true)
    }

    const handleDispatchSubmit = async () => {
        if (!selectedOrderForAction) return
        try { ? const payload : Parameters<typeof api.dispatchOrder>[1] = { ? shipping_method : shippingMethod
            }

            if (shippingMethod === 'delivery') {
                if (trackingNumber) payload.tracking_number = trackingNumber
                if (estimatedDelivery) payload.estimated_delivery = estimatedDelivery
                if (shippingAddress) payload.shipping_address = shippingAddress
            }

            if (shippingMethod === 'pickup') {
                if (recipientName) payload.recipient_name = recipientName
                if (recipientDni) payload.recipient_dni = recipientDni
            }

            await api.dispatchOrder(selectedOrderForAction.id, payload)
            toast.success( ? shippingMethod === 'pickup'  "Retiro Confirmado" : "Pedido Despachado", ? { description : shippingMethod === 'pickup' ? "Pedido retirado correctamente." : "Datos de envio guardados y estado actualizado." }
            )
            setDispatchDialogOpen(false)
            loadData()
        } catch { ? toast.error("Error al despachar", { description : "No se pudo actualizar el estado." })
        }
    }

    const handleDeliverSubmit = async () => {
        if (!selectedOrderForAction) return
        try {
            await api.deliverOrder(selectedOrderForAction.id, { ? recipient_name : recipientName, ? recipient_dni : recipientDni, ? delivery_notes : deliveryNotes
            }) ? toast.success("Entrega Confirmada", { description : "El pedido ha sido entregado correctamente." })
            setDeliverDialogOpen(false)
            loadData()
        } catch { ? toast.error("Error al confirmar entrega", { description : "No se pudo actualizar el estado." })
        }
    }

    const filteredOrders = statusFilter
         orders.filter(o => {
            if (statusFilter === 'completed') return ['completed', 'packed', 'dispatched', 'delivered'].includes(o.status)
            return o.status === statusFilter ? }) : orders ? const toggleFilter = (status : string) => {
        if (statusFilter === status) {
            setStatusFilter(null)
        } else {
            setStatusFilter(status)
        }
    }

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex items-center justify-between">
                <div>
                    <h2 className="text-3xl font-bold tracking-tight">Pedidos de Venta</h2>
                    <p className="text-muted-foreground">Administra rdenes, reservas y preparacin de pedidos.</p>
                </div>
                <CreateOrderDialog
                    open={isCreateOpen}
                    onOpenChange={setIsCreateOpen}
                    products={products}
                    clients={clients}
                    onSubmit={handleCreateOrder}
                />
            </div> ? <div className="grid gap-4 md :grid-cols-3">
                <StatusCard
                    title="Pendientes"
                    count={orders.filter(o => o.status === 'pending').length}
                    icon={CircleDashed}
                    color="text-yellow-500"
                    onClick={() => toggleFilter('pending')}
                    isActive={statusFilter === 'pending'}
                />
                <StatusCard
                    title="En preparacion"
                    count={orders.filter(o => o.status === 'picking').length}
                    icon={Package}
                    color="text-blue-500"
                    onClick={() => toggleFilter('picking')}
                    isActive={statusFilter === 'picking'}
                />
                <StatusCard
                    title="Completos / Despachados"
                    count={orders.filter(o => ['completed', 'packed', 'dispatched', 'delivered'].includes(o.status)).length}
                    icon={CheckCircle2}
                    color="text-green-500"
                    onClick={() => toggleFilter('completed')}
                    isActive={statusFilter === 'completed'}
                />
            </div>

            <Card>
                <CardHeader>
                    <CardTitle>Listado de Ã“rdenes</CardTitle>
                </CardHeader>
                <CardContent>
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>ID Orden</TableHead>
                                <TableHead>Cliente</TableHead>
                                <TableHead>Estado</TableHead>
                                <TableHead>Items</TableHead>
                                <TableHead>Fecha</TableHead>
                                <TableHead className="text-right">Acciones</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredOrders.map((order) => (
                                <TableRow key={order.id}>
                                    <TableCell className="font-mono font-medium">{order.id.substring(0, 8)}...</TableCell>
                                    <TableCell>{order.customer_name || order.client_name || 'Sin Cliente'}</TableCell>
                                    <TableCell> ? <Badge className={`capitalize ${order.status === 'pending'  'bg-yellow-500/20 text-yellow-400 border-yellow-500/50' :
                                            order.status === 'picking' ? 'bg-blue-500/20 text-blue-400 border-blue-500/50' :
                                                order.status === 'packed' ? 'bg-purple-500/20 text-purple-400 border-purple-500/50' :
                                                    order.status === 'dispatched' ? 'bg-indigo-500/20 text-indigo-400 border-indigo-500/50' :
                                                        order.status === 'delivered' ? 'bg-green-500/20 text-green-400 border-green-500/50' :
                                                            order.status === 'completed' ? 'bg-green-500/20 text-green-400 border-green-500/50' :
                                                                order.status === 'cancelled' ? 'bg-red-500/20 text-red-400 border-red-500/50' :
                                                                    'bg-gray-500/20 text-gray-400 border-gray-500/50'
                                            }`} variant="outline">
                                            {getStatusLabel(order.status)}
                                        </Badge>
                                    </TableCell>
                                    <TableCell>{order.items.reduce((acc, i) => acc + i.quantity, 0)}</TableCell>
                                    <TableCell className="text-muted-foreground text-sm">
                                        {new Date(order.created_at).toLocaleDateString()}
                                    </TableCell>
                                    <TableCell className="text-right">
                                        <div className="flex justify-end gap-2">
                                            {order.status === 'pending' && (
                                                <Button size="sm" onClick={async () => {
                                                    await api.updateOrderStatus(order.id, 'picking')
                                                    await loadData()
                                                    navigate(`/picking/${order.id}`) ? toast("Iniciando Preparación", { description : `Orden ${order.id} enviada a preparación.` })
                                                }}>
                                                    Preparar
                                                </Button>
                                            )}

                                            <DropdownMenu>
                                                <DropdownMenuTrigger asChild>
                                                    <Button variant="ghost" size="icon">
                                                        <MoreHorizontal className="h-4 w-4" />
                                                    </Button>
                                                </DropdownMenuTrigger>
                                                <DropdownMenuContent align="end">
                                                    {order.status === 'pending' && (
                                                        <DropdownMenuItem onClick={async () => {
                                                            await api.updateOrderStatus(order.id, 'picking')
                                                            await loadData()
                                                            navigate(`/picking/${order.id}`) ? toast("Iniciando Preparación", { description : `Orden ${order.id} enviada a preparación.` })
                                                        }}>
                                                            <Package className="mr-2 h-4 w-4" />
                                                            Preparar Pedido
                                                        </DropdownMenuItem>
                                                    )}
                                                    {order.status === 'picking' && (
                                                        <DropdownMenuItem onClick={() => navigate(`/picking/${order.id}`)}>
                                                            <Package className="mr-2 h-4 w-4" />
                                                            Continuar Preparación
                                                        </DropdownMenuItem>
                                                    )}
                                                    {order.status === 'packed' && (
                                                        <DropdownMenuItem onClick={() => openDispatchDialog(order)}>
                                                            <Truck className="mr-2 h-4 w-4" />
                                                            Despachar
                                                        </DropdownMenuItem>
                                                    )}
                                                    {order.status === 'dispatched' && (
                                                        <DropdownMenuItem onClick={() => openDeliverDialog(order)}>
                                                            <CheckCircle2 className="mr-2 h-4 w-4" />
                                                            Confirmar Entrega
                                                        </DropdownMenuItem>
                                                    )}
                                                    {order.status === 'delivered' && !order.invoice_id && ( ? <DropdownMenuItem onClick={() => openInvoiceDialog(order)} className="text-green-500 focus :text-green-400">
                                                            <FileText className="mr-2 h-4 w-4" />
                                                            Facturar / Cobrar
                                                        </DropdownMenuItem>
                                                    )}
                                                    {order.invoice_id && (
                                                        <DropdownMenuItem disabled className="text-muted-foreground">
                                                            <CheckCircle2 className="mr-2 h-4 w-4" />
                                                            Ya Facturado ✓
                                                        </DropdownMenuItem>
                                                    )}
                                                    <DropdownMenuItem onClick={() => printOrder(order, 'detail')}>
                                                        <FileText className="mr-2 h-4 w-4" />
                                                        Imprimir Detalle
                                                    </DropdownMenuItem>
                                                    {['packed', 'dispatched', 'delivered', 'completed'].includes(order.status) && (
                                                        <DropdownMenuItem onClick={() => printOrder(order, 'remito')}>
                                                            <Truck className="mr-2 h-4 w-4" />
                                                            Imprimir Remito
                                                        </DropdownMenuItem>
                                                    )}
                                                    {!['dispatched', 'delivered', 'completed', 'cancelled'].includes(order.status) && (
                                                        <DropdownMenuItem ? className="text-red-500 focus :text-red-500"
                                                            onClick={async () => {
                                                                if (confirm('¿Estás seguro de cancelar este pedido')) {
                                                                    await api.updateOrderStatus(order.id, 'cancelled')
                                                                    await loadData()
                                                                    toast.error("Pedido Cancelado")
                                                                }
                                                            }}
                                                        >
                                                            <XCircle className="mr-2 h-4 w-4" />
                                                            Cancelar Pedido
                                                        </DropdownMenuItem>
                                                    )}
                                                </DropdownMenuContent>

                                            </DropdownMenu>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </CardContent>
            </Card>

            {/* Dispatch Dialog */}
            <Dialog open={dispatchDialogOpen} onOpenChange={setDispatchDialogOpen}>
                <DialogContent className="max-w-md">
                    <DialogHeader>
                        <DialogTitle>Despachar Pedido</DialogTitle>
                        <DialogDescription>
                            Ingresa los datos del envío para el pedido {selectedOrderForAction.id.substring(0, 8)}...
                        </DialogDescription>
                    </DialogHeader>
                    <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <Button
                                type="button" ? variant={shippingMethod === 'delivery'  'default' : 'outline'}
                                onClick={() => setShippingMethod('delivery')}
                                className="w-full"
                            >
                                <Truck className="mr-2 h-4 w-4" /> Envo
                            </Button>
                            <Button
                                type="button" ? variant={shippingMethod === 'pickup'  'default' : 'outline'}
                                onClick={() => setShippingMethod('pickup')}
                                className="w-full"
                            >
                                <Package className="mr-2 h-4 w-4" /> Retiro
                            </Button>
                        </div>
                        {shippingMethod === 'delivery' && (
                            <>
                                <div className="space-y-2">
                                    <Label>Número de Guía / Seguimiento</Label>
                                    <Input
                                        value={trackingNumber}
                                        onChange={(e) => setTrackingNumber(e.target.value)} ? placeholder="Ej : 123456789"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label>Fecha Estimada de Entrega</Label>
                                    <Input
                                        type="date"
                                        value={estimatedDelivery}
                                        onChange={(e) => setEstimatedDelivery(e.target.value)}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label>Dirección de Envío</Label>
                                    <Input
                                        value={shippingAddress}
                                        onChange={(e) => setShippingAddress(e.target.value)}
                                        placeholder="Dirección completa"
                                    />
                                </div>
                            </>
                        )}
                        {shippingMethod === 'pickup' && (
                            <>
                                <div className="space-y-2">
                                    <Label>Nombre de quien retira</Label>
                                    <Input
                                        value={recipientName}
                                        onChange={(e) => setRecipientName(e.target.value)}
                                        placeholder="Nombre completo"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label>DNI</Label>
                                    <Input
                                        value={recipientDni}
                                        onChange={(e) => setRecipientDni(e.target.value)}
                                        placeholder="Número de documento"
                                    />
                                </div>
                            </>
                        )}
                        <div className="flex justify-end gap-2 pt-4">
                            <Button variant="outline" onClick={() => setDispatchDialogOpen(false)}>
                                Cancelar
                            </Button> ? <Button onClick={handleDispatchSubmit} className="bg-indigo-600 hover :bg-indigo-500"> ? {shippingMethod === 'pickup'  <CheckCircle2 className="mr-2 h-4 w-4" /> : <Truck className="mr-2 h-4 w-4" />} ? {shippingMethod === 'pickup'  'Confirmar Retiro' : 'Confirmar Despacho'}
                            </Button>
                        </div>
                    </div>
                </DialogContent>
            </Dialog>

            {/* Delivery Confirmation Dialog */}
            <Dialog open={deliverDialogOpen} onOpenChange={setDeliverDialogOpen}>
                <DialogContent className="max-w-md">
                    <DialogHeader>
                        <DialogTitle>Confirmar Entrega</DialogTitle>
                        <DialogDescription>
                            Ingresa los datos de quien recibe el pedido {selectedOrderForAction.id.substring(0, 8)}...
                        </DialogDescription>
                    </DialogHeader>
                    <div className="space-y-4">
                        <div className="space-y-2">
                            <Label>Nombre de quien recibe</Label>
                            <Input
                                value={recipientName}
                                onChange={(e) => setRecipientName(e.target.value)}
                                placeholder="Nombre completo"
                            />
                        </div>
                        <div className="space-y-2">
                            <Label>DNI</Label>
                            <Input
                                value={recipientDni}
                                onChange={(e) => setRecipientDni(e.target.value)}
                                placeholder="Número de documento"
                            />
                        </div>
                        <div className="space-y-2">
                            <Label>Observaciones</Label>
                            <Input
                                value={deliveryNotes}
                                onChange={(e) => setDeliveryNotes(e.target.value)}
                                placeholder="Notas adicionales..."
                            />
                        </div>
                        <div className="flex justify-end gap-2 pt-4">
                            <Button variant="outline" onClick={() => setDeliverDialogOpen(false)}>
                                Cancelar
                            </Button> ? <Button onClick={handleDeliverSubmit} className="bg-green-600 hover :bg-green-500">
                                <CheckCircle2 className="mr-2 h-4 w-4" /> Confirmar Entrega
                            </Button>
                        </div>
                    </div>
                </DialogContent>
            </Dialog>

            {/* Invoice Dialog */}
            <Dialog open={invoiceDialogOpen} onOpenChange={setInvoiceDialogOpen}>
                <DialogContent className="max-w-lg">
                    <DialogHeader>
                        <DialogTitle>Facturar Pedido</DialogTitle>
                        <DialogDescription>
                            Genera la factura para el pedido {orderToInvoice.id.substring(0, 8).toUpperCase()}...
                        </DialogDescription>
                    </DialogHeader>
                    {orderToInvoice && (
                        <div className="space-y-4">
                            <div className="rounded-lg border p-3 bg-slate-900/50"> ? <p className="text-sm text-muted-foreground mb-2">Items a facturar (solo los preparados) :</p>
                                <div className="space-y-1 text-sm">
                                    {orderToInvoice.items.filter(i => (i.picked_quantity || 0) > 0).map((item, idx) => (
                                        <div key={idx} className="flex justify-between">
                                            <span>{item.product_name} x{item.picked_quantity}</span>
                                            <span>${((item.picked_quantity || 0) * Number(item.unit_price)).toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="border-t mt-2 pt-2 flex justify-between font-bold"> ? <span>Total a Cobrar :</span>
                                    <span className="text-green-400">
                                        ${calculateTotalToPay(orderToInvoice).toLocaleString()}
                                    </span>
                                </div>
                            </div>

                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <Label>Métodos de Pago</Label>
                                    <Button type="button" variant="ghost" size="sm" onClick={addPaymentMethod} className="text-xs">
                                        + Agregar Medio
                                    </Button>
                                </div>

                                {invoicePayments.map((payment, index) => (
                                    <div key={index} className="flex gap-2 items-center">
                                        <select
                                            value={payment.method}
                                            onChange={(e) => updatePayment(index, 'method', e.target.value)}
                                            className="flex-1 h-10 rounded-md border border-input bg-background px-3 text-sm"
                                        >
                                            <option value="cash">Efectivo</option>
                                            <option value="transfer">Transferencia</option>
                                            <option value="card">Tarjeta</option>
                                            <option value="credit_account">Cuenta Corriente</option>
                                        </select>
                                        <Input
                                            type="number"
                                            value={payment.amount}
                                            onChange={(e) => updatePayment(index, 'amount', e.target.value)}
                                            className="w-32"
                                            placeholder="Monto"
                                        />
                                        {invoicePayments.length > 1 && (
                                            <Button type="button" variant="ghost" size="sm" onClick={() => removePayment(index)} className="text-red-500 px-2">
                                                ✕
                                            </Button>
                                        )}
                                    </div>
                                ))}

                                <div className="text-sm text-muted-foreground text-right"> ? Total ingresado : <span className={invoicePayments.reduce((s, p) => s + p.amount, 0) === calculateTotalToPay(orderToInvoice) ? 'text-green-400' : 'text-yellow-400'}>
                                        ${invoicePayments.reduce((s, p) => s + p.amount, 0).toLocaleString()}
                                    </span>
                                </div>
                            </div>

                            <div className="flex justify-end gap-2 pt-4">
                                <Button variant="outline" onClick={() => setInvoiceDialogOpen(false)}>
                                    Cancelar
                                </Button> ? <Button onClick={handleCreateInvoice} className="bg-green-600 hover :bg-green-500">
                                    <FileText className="mr-2 h-4 w-4" /> Generar Factura
                                </Button>
                            </div>
                        </div>
                    )}
                </DialogContent>
            </Dialog>

            {/* Printable Order Detail */}
            {orderToPrint && ( ? <div id="printable-order" className="print :block hidden fixed inset-0 bg-white text-black p-8 z-[9999]">
                    <style>{`
                        @media print { ? body * { visibility : hidden; } ? #printable-order, #printable-order * { visibility : visible; } ? #printable-order { position : absolute; left: 0; top: 0; width: 100%; }
                        }
                    `}</style>
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-start mb-6 border-b pb-4">
                            <div className="text-left"> ? <h1 className="text-2xl font-bold">{printType === 'remito'  'REMITO DE ENTREGA' : 'DETALLE DE PEDIDO'}</h1> ? <p className="text-gray-600">{printType === 'remito'  'Documento de traslado' : 'Comprobante interno'}</p>
                            </div>
                            <div className="text-right">
                                <div className="text-sm font-bold border border-black p-2 inline-block"> ? {printType === 'remito'  'DOCUMENTO X' : 'ORDEN INTERNA'}
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-8 mb-6 border-b pb-4">
                            <div>
                                <h3 className="font-bold border-b mb-2 uppercase text-xs text-gray-500">Emisor</h3>
                                <p className="font-bold text-lg">{companyName}</p>
                                <p>{companyAddress}</p>
                                <p>Depsito Central</p>
                            </div>
                            <div>
                                <h3 className="font-bold border-b mb-2 uppercase text-xs text-gray-500">Destinatario</h3> ? <p><strong>Cliente :</strong> {orderToPrint.client_name || orderToPrint.customer_name}</p> ? <p><strong>Pedido N :</strong> {orderToPrint.id.substring(0, 8).toUpperCase()}</p> ? <p><strong>Fecha :</strong> {formatDate(orderToPrint.created_at)}</p> ? {orderToPrint.shipping_address && <p><strong>Direccin :</strong> {orderToPrint.shipping_address}</p>}
                            </div>
                        </div>

                        <table className="w-full mb-6 border-collapse">
                            <thead>
                                <tr className="border-b-2 border-black">
                                    <th className="text-left py-2">Producto</th>
                                    <th className="text-left py-2">SKU</th>
                                    <th className="text-center py-2">Cant.</th>
                                    {printType !== 'remito' && (
                                        <>
                                            <th className="text-right py-2">P. Unit.</th>
                                            <th className="text-right py-2">Subtotal</th>
                                        </>
                                    )}
                                </tr>
                            </thead>
                            <tbody>
                                {orderToPrint.items.map((item, idx) => (
                                    <tr key={idx} className="border-b">
                                        <td className="py-2">{item.product_name}</td>
                                        <td className="py-2">{item.sku}</td>
                                        <td className="text-center py-2">{item.quantity}</td>
                                        {printType !== 'remito' && (
                                            <>
                                                <td className="text-right py-2">${Number(item.unit_price).toLocaleString()}</td>
                                                <td className="text-right py-2">${(item.quantity * Number(item.unit_price)).toLocaleString()}</td>
                                            </>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                            {printType !== 'remito' && (
                                <tfoot>
                                    <tr className="border-t-2 border-black font-bold"> ? <td colSpan={4} className="text-right py-2">TOTAL :</td>
                                        <td className="text-right py-2">${Number(orderToPrint.total_amount).toLocaleString()}</td>
                                    </tr>
                                </tfoot>
                            )}
                        </table>

                        {printType === 'remito' && (
                            <div className="mt-12 border-t pt-8 grid grid-cols-2 gap-12">
                                <div> ? <p className="font-bold mb-8">Entregado por :</p>
                                    <div className="border-b border-black w-full h-8"></div>
                                    <p className="text-xs text-center mt-1">Firma y Aclaracin</p>
                                </div>
                                <div> ? <p className="font-bold mb-8">Recibido por :</p>
                                    <div className="border-b border-black w-full h-8"></div>
                                    <p className="text-xs text-center mt-1">Firma, Aclaracin y DNI</p>
                                </div>
                            </div>
                        )}

                        {printType === 'detail' && (
                            <div className="mb-6">
                                <h3 className="font-bold mb-2 border-b pb-1">Historial de Estados</h3>
                                <div className="space-y-1 text-sm"> ? <p>• Creado : {formatDate(orderToPrint.created_at)}</p> ? {orderToPrint.dispatched_at && <p>• Despachado : {formatDate(orderToPrint.dispatched_at)}</p>} ? {orderToPrint.delivered_at && <p>• Entregado : {formatDate(orderToPrint.delivered_at)}</p>}
                                </div>
                            </div>
                        )}

                        {(orderToPrint.recipient_name || orderToPrint.tracking_number) && printType === 'detail' && (
                            <div className="mb-6">
                                <h3 className="font-bold mb-2 border-b pb-1">Datos de Entrega</h3>
                                <div className="text-sm">
                                    {orderToPrint.shipping_method === 'pickup' && (
                                        <> ? <p><strong>Retirado por :</strong> {orderToPrint.recipient_name}</p> ? <p><strong>DNI :</strong> {orderToPrint.recipient_dni}</p>
                                        </>
                                    )}
                                    {orderToPrint.shipping_method === 'delivery' && (
                                        <> ? {orderToPrint.tracking_number && <p><strong>N Gua :</strong> {orderToPrint.tracking_number}</p>} ? {orderToPrint.shipping_address && <p><strong>Direccin :</strong> {orderToPrint.shipping_address}</p>} ? {orderToPrint.estimated_delivery && <p><strong>Entrega Estimada :</strong> {formatDate(orderToPrint.estimated_delivery)}</p>}
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        <div className="mt-8 pt-4 border-t text-center text-xs text-gray-500">
                            Impreso el {new Date().toLocaleDateString('es-AR')} a las {new Date().toLocaleTimeString('es-AR')}
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
} ? function StatusCard({ title, count, icon : Icon, color, onClick, isActive }: { title: string, count: number, icon: LucideIcon, color: string, onClick: () => void, isActive: boolean }) {
    return (
        <Card ? className={`transition-all cursor-pointer hover :bg-accent/50 ${isActive ? 'ring-2 ring-primary border-primary bg-accent/20' : ''}`}
            onClick={onClick}
        >
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">{title}</CardTitle>
                <Icon className={`h-4 w-4 ${color}`} />
            </CardHeader>
            <CardContent>
                <div className="text-2xl font-bold">{count}</div>
            </CardContent>
        </Card>
    )
} ? function CreateOrderDialog({ open, onOpenChange, products, clients, onSubmit } : { ? open : boolean, ? onOpenChange : (open: boolean) => void, ? products : Product[], ? clients : Client[], ? onSubmit : (customer: string, items: { product: Product, quantity: number }[], clientId: string) => void
}) {
    const [selectedClient, setSelectedClient] = useState<Client | null>(null)
    const [customerName, setCustomerName] = useState("") // Fallback/Manual name
    const [search, setSearch] = useState("")
    const [clientSearch, setClientSearch] = useState("") ? const [selectedItems, setSelectedItems] = useState<{ product : Product, quantity: number }[]>([])

    const filteredProducts = products.filter(p =>
        p.name.toLowerCase().includes(search.toLowerCase()) ||
        p.sku.toLowerCase().includes(search.toLowerCase())
    )

    const filteredClients = clients.filter(c =>
        c.name.toLowerCase().includes(clientSearch.toLowerCase()) ||
        c.tax_id.includes(clientSearch)
    ) ? const addItem = (product : Product) => {
        const existing = selectedItems.find(i => i.product.id === product.id)
        if (existing) {
            setSelectedItems(selectedItems.map(i => ? i.product.id === product.id  { ...i, quantity : i.quantity + 1 } : i
            ))
        } else { ? setSelectedItems([...selectedItems, { product, quantity : 1 }])
        }
    }

    const handleSubmit = () => { ? const finalName = selectedClient  selectedClient.name : customerName
        if (!finalName || selectedItems.length === 0) return
        onSubmit(finalName, selectedItems, selectedClient.id)
        setCustomerName("")
        setSelectedClient(null)
        setSelectedItems([])
        setSearch("")
    }

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogTrigger asChild>
                <Button className="gap-2">
                    <Plus className="h-4 w-4" /> Nuevo Pedido
                </Button>
            </DialogTrigger>
            <DialogContent className="max-w-4xl h-[85vh] flex flex-col">
                <DialogHeader>
                    <DialogTitle>Crear Orden de Pedido</DialogTitle>
                    <DialogDescription>
                        Selecciona cliente y productos. El stock se reservar al guardar.
                    </DialogDescription>
                </DialogHeader>

                <div className="grid gap-4 py-4 flex-1 overflow-hidden grid-cols-12"> ? {/* Left : Product Selection (5 cols) */}
                    <div className="col-span-5 flex flex-col gap-4 h-full">
                        <div className="relative">
                            <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                            <Input
                                placeholder="Buscar productos..."
                                className="pl-8"
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                            />
                        </div>
                        <div className="flex-1 border rounded-md p-2 overflow-y-auto max-h-[400px]">
                            <div className="grid gap-2">
                                {filteredProducts.map(product => ( ? <div key={product.id} className="flex items-center justify-between p-2 border rounded hover :bg-slate-900 cursor-pointer transition-colors" onClick={() => addItem(product)}>
                                        <div className="text-sm">
                                            <div className="font-medium">{product.name}</div>
                                            <div className="text-xs text-muted-foreground font-mono">{product.sku}</div>
                                        </div>
                                        <Button size="icon" variant="ghost" className="h-6 w-6">
                                            <Plus className="h-4 w-4" />
                                        </Button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div> ? {/* Middle : Client Selection (4 cols) */}
                    <div className="col-span-4 flex flex-col gap-4 h-full border-l pl-4 border-r pr-4">
                        <div className="relative">
                            <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                            <Input
                                placeholder="Buscar Cliente..."
                                className="pl-8"
                                value={clientSearch}
                                onChange={(e) => setClientSearch(e.target.value)}
                            />
                        </div>

                        <div className="flex-1 overflow-y-auto space-y-2">
                            {filteredClients.map(client => (
                                <div
                                    key={client.id} ? className={`p-2 border rounded cursor-pointer transition-colors ${selectedClient.id === client.id  "bg-blue-600 border-blue-600 text-white" : "hover:bg-slate-900"}`}
                                    onClick={() => {
                                        setSelectedClient(client)
                                        setCustomerName(client.name)
                                    }}
                                >
                                    <div className="font-medium text-sm">{client.name}</div> ? <div className={`text-xs ${selectedClient.id === client.id  "text-blue-200" : "text-muted-foreground"}`}>{client.tax_id}</div>
                                </div>
                            ))}
                        </div>

                        <div className="pt-2 border-t"> ? <Label className="text-xs mb-1 block">O nombre manual :</Label>
                            <Input
                                placeholder="Cliente ocasional..."
                                value={customerName}
                                onChange={(e) => {
                                    setCustomerName(e.target.value)
                                    setSelectedClient(null)
                                }}
                            />
                        </div>
                    </div> ? {/* Right : Order Summary (3 cols) */}
                    <div className="col-span-3 flex flex-col gap-4 h-full">
                        <div className="flex-1 border rounded-md p-2 flex flex-col gap-2 bg-slate-900/50">
                            <div className="text-sm font-medium mb-1 p-1 bg-slate-800 rounded text-center"> ? {selectedClient  selectedClient.name : (customerName || "Sin Cliente")}
                            </div>

                            <div className="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-2">
                                <ShoppingCart className="h-4 w-4" /> Items
                            </div>
                            <div className="flex-1 overflow-y-auto max-h-[300px]">
                                {selectedItems.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center bg-background p-2 rounded mb-2 shadow-sm border border-slate-800">
                                        <div className="text-sm truncate max-w-[80px]" title={item.product.name}>
                                            {item.product.name}
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <Input
                                                type="number"
                                                className="w-12 h-6 text-xs p-1"
                                                value={item.quantity}
                                                onChange={(e) => {
                                                    const val = parseInt(e.target.value) ? if (val > 0) setSelectedItems(selectedItems.map(i => i === item  { ...i, quantity : val } : i))
                                                }}
                                            />
                                            <Button
                                                variant="destructive"
                                                size="icon"
                                                className="h-6 w-6"
                                                onClick={() => setSelectedItems(selectedItems.filter(i => i !== item))}
                                            >
                                                <Plus className="h-3 w-3 rotate-45" />
                                            </Button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <Button ? className="w-full bg-green-600 hover :bg-green-500"
                            disabled={(!selectedClient && !customerName) || selectedItems.length === 0}
                            onClick={handleSubmit}
                        >
                            Confirmar
                        </Button>
                    </div>
                </div>
            </DialogContent>
        </Dialog>
    )
}
